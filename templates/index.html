{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Soumya">
    <meta name="keyword" content="Corona, globe, world, covid, covid19">
    <title>Go Covid!</title>
    
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}" >
    <link rel="stylesheet" href="{% static 'css/jquery.dataTables.css' %}" >
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Varela+Round&display=swap">
    <!-- <link rel="stylesheet" href="{% static 'css/three-dots.css' %}" > -->
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-36253852-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-36253852-2');
    </script>
    <style>
    body {
      font-family: 'Varela Round', sans-serif;
      background: ghostwhite;
      padding: .5rem;
      font-size: .8rem;
    }
    .card {
      padding: .5rem !important;
      border: 0;
    }
    caption { 
      caption-side: top; 
      margin: 0;
      padding: 0;
    }
    table.dataTable thead th, table.dataTable thead td {
      border: none,
      color:red;
    }
    .dataTableSearch {
      padding: 0.375rem 0.75rem;
      font-size: .8rem;
      line-height: 1;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      border: 1px solid #ced4da;
      border-radius: 0.25rem;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      
    }
    .dataTables_filter {
      padding: 0;
      margin: 0;
    }
    .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody > table > thead > tr > th, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody > table > thead > tr > td, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody > table > tbody > tr > th, .dataTables_wrapper .dataTables_scroll div.dataTables_scrollBody > table > tbody > tr > td {
      padding: 0;
      font-size:.8rem;
    }
    table.dataTable thead .sorting, table.dataTable thead .sorting_asc, table.dataTable thead .sorting_desc, table.dataTable thead .sorting_asc_disabled, table.dataTable thead .sorting_desc_disabled {
      padding: 0;     
      font-size:.8rem; 
    }
    table.dataTable thead td{
      border-bottom: 1px solid #efefef;
    }
    table.dataTable tfoot td{
      border-bottom: 1px solid #efefef;
    }
    table.dataTable.no-footer {
      border-bottom: 1px solid #efefef;
    }
    </style>
  </head>
  

  <body>
    {{ data|json_script:"hello-data" }}
    {{ summary|json_script:"summary-data" }}
    
    <header>
      <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark p-0 m-0">
        <span class="navbar-brand lead text-warning p-2" href="#">COVID-19</span>        
      </nav>
    </header>

    <main role="main" class="container-fluid p-0 mx-auto" style="max-width:500px">
      <div class="mt-5"></div>
      <!-- 
        <div class="mt-5">
        <div class="lead">GLOBAL SITUATION</div>      
      </div>
      -->
      <!-- SPARK LINES -->
      <div class="card card-body shadow-sm">
        <div class="row">
          <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4 col-4 text-center text-warning">
            <div>Confirmed</div>
            <div id="confirmed-count">--</div>
            <div id="spark-confirmed"></div>
          </div>
          <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4 col-4 text-center text-success">
            <div>Recovered</div>
            <div id="recovered-count">--</div>
            <div id="spark-recovered"></div>
          </div>
          <div class="col-xl-4 col-lg-4 col-md-4 col-sm-4 col-4 text-center text-danger">
            <div>Deaths</div>
            <div id="deaths-count">--</div>
            <div id="spark-deaths"></div>
          </div>
        </div> <!-- /row -->
      </div>
      <br/>
      <div class="card card-body shadow-sm">
        <div class="row">
          <div class="col-12">      
            <table id="table-count" class="table table-sm no-footer display" 
              cellspacing="0" width="100%" >
              
              <thead>
                <tr class="text-left">
                  <td class="compact"></td>
                  <td class="compact">Confirmed</td>
                  <td class="compact">Recovered</td>
                  <td class="compact">Deaths</td>
                </tr>
              </thead>
              <tbody></tbody>
            </table> 
          </div> <!-- /col-12 -->
        </div> <!-- /row -->
      </div> <!-- /card-->
          
      <!-- Choropleth map header -->
      <!-- <div>
        <div class="lead">COVID MAP</div>        
      </div> -->
      <br>      
      <!-- Choropleth map -->
      <div class="card card-body shadow-sm">
        <div class="row">
          <div class="col-12">      
            <iframe frameBorder="0" id="foo" style="width:100%;height:350px;" srcdoc='{{map_html|escape}}'></iframe>
          </div> <!-- /col-12 -->
        </div> <!-- /row -->
      </div> <!-- /card-->
      
      <!-- Covid globe header -->
      <!-- <div>
        <div class="lead">COVID Globe</div>        
      </div> -->
      <br/>      
      <!-- Covid globe -->
      <div class="card card-body shadow-sm">
        <div class="row"> 
          <div class="col-12 text-center">      
            <canvas id='globe' height=350 width=350></canvas>
          </div> <!-- /col-12 -->
        </div> <!-- /row -->
      </div> <!-- /card-->
      


    

      
    </main>

    <footer class="footer">
      <div class="container-fluid p-0">
        <span class="text-muted">
          Last refreshed:<span id="lastrefreshed"></span>        
        </span>
      </div>
    </footer>

    <script src="{% static 'js/jquery-3.2.1.js' %}" ></script>
    <script src="{% static 'js/popper.1.12.9.js' %}" ></script>
    <script src="{% static 'js/bootstrap.4.0.0.js' %}"></script>
    <script src="{% static 'js/jquery.timeago.js' %}"></script>
    <script src="{% static 'js/sparklines.js' %}"></script>
    <script src="{% static 'js/jquery.sparkline.js' %}"></script>
    <script src="{% static 'js/sparkline-chart.js' %}"></script>  
    <script src="{% static 'js/jquery.dataTables.1.10.20.js' %}"></script>  

    <script type='text/javascript' src='https://d3js.org/d3.v3.min.js'></script>
    <script type='text/javascript' src='https://d3js.org/topojson.v1.min.js'></script>
    <script type='text/javascript' src='https://cdn.rawgit.com/BinaryMuse/planetary.js/v1.1.2/dist/planetaryjs.min.js'></script>
    <script type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script>
      $(function() {      
        
        console.log("Page loaded!");
        var summary = JSON.parse(document.getElementById('summary-data').textContent);
        
        handleTimeago();  
        handleSparks(summary); 
        handleCountDataTable(summary); 
        handleGlobe();   
        
        // functions
        function handleTimeago(){
          jQuery("time.timeago").timeago();
          $("#lastrefreshed").text(jQuery.timeago(summary.utc_dt));
        }
        
        function handleSparks(summary) {
          $('#spark-confirmed').sparkline(summary.trend_confirmed, {height: 40,width: '100%',lineWidth: 2,fillColor: false,lineColor: "orange",spotColor: 'orange',spotRadius: 2});
          $('#spark-recovered').sparkline(summary.trend_recovered, {height: 40,width: '100%',fillColor: false,lineColor: "#26c281",spotRadius: 2,lineWidth: 2});
          $('#spark-deaths').sparkline(summary.trend_deaths, {height: 40,width: '100%',fillColor: false,lineColor: "tomato",spotColor: 'tomato',spotRadius: 2,lineWidth: 2});
          $("#recovered-count").text(summary.totals.total_recovered.toLocaleString())
          $("#confirmed-count").text(summary.totals.total_confirmed.toLocaleString())
          $("#deaths-count").text(summary.totals.total_deaths.toLocaleString())
        }

        function handleCountDataTable(summary, cntry){
          var cntry = { "AFG": "Afghanistan", "ALB": "Albania", "DZA": "Algeria", "AND": "Andorra", "AGO": "Angola", "ATG": "Antigua", "ARG": "Argentina", "ARM": "Armenia", "AUS": "Australia", "AUT": "Austria", "AZE": "Azerbaijan", "BHS": "Bahamas", "BHR": "Bahrain", "BGD": "Bangladesh", "BRB": "Barbados", "BLR": "Belarus", "BEL": "Belgium", "BLZ": "Belize", "BEN": "Benin", "BTN": "Bhutan", "BOL": "Bolivia", "BIH": "Bosnia", "BWA": "Botswana", "BRA": "Brazil", "BRN": "Brunei", "BGR": "Bulgaria", "BFA": "Burkina", "BDI": "Burundi", "CPV": "CaboVerde", "KHM": "Cambodia", "CMR": "Cameroon", "CAN": "Canada", "CAF": "Central African Republic", "TCD": "Chad", "CHL": "Chile", "CHN": "China", "COL": "Colombia", "COM": "Comoros", "COG": "Congo", "COD": "Congo", "CRI": "Costa Rica", "CIV": "CÃ´te d'Ivoire", "HRV": "Croatia", "CUB": "Cuba", "CYP": "Cyprus", "CZE": "Czechia", "DNK": "Denmark", "DJI": "Djibouti", "DMA": "Dominica", "DOM": "Dominican Rep", "ECU": "Ecuador", "EGY": "Egypt", "SLV": "El Salvador", "GNQ": "Guinea", "ERI": "Eritrea", "EST": "Estonia", "SWZ": "Eswatini", "ETH": "Ethiopia", "FJI": "Fiji", "FIN": "Finland", "FRA": "France", "GAB": "Gabon", "GMB": "Gambia", "GEO": "Georgia", "DEU": "Germany", "GHA": "Ghana", "GRC": "Greece", "GRD": "Grenada", "GTM": "Guatemala", "GIN": "Guinea", "GNB": "Guinea Bissau", "GUY": "Guyana", "HTI": "Haiti", "HND": "Honduras", "HUN": "Hungary", "ISL": "Iceland", "IND": "India", "IDN": "Indonesia", "IRN": "Iran", "IRQ": "Iraq", "IRL": "Ireland", "ISR": "Israel", "ITA": "Italy", "JAM": "Jamaica", "JPN": "Japan", "JOR": "Jordan", "KAZ": "Kazakhstan", "KEN": "Kenya", "KIR": "Kiribati", "PRK": "S Korea", "KOR": "N Korea", "KWT": "Kuwait", "KGZ": "Kyrgyzstan", "LAO": "Lao", "LVA": "Latvia", "LBN": "Lebanon", "LSO": "Lesotho", "LBR": "Liberia", "LBY": "Libya", "LIE": "Liechten stein", "LTU": "Lithuania", "LUX": "Luxembourg", "MDG": "Madagascar", "MWI": "Malawi", "MYS": "Malaysia", "MDV": "Maldives", "MLI": "Mali", "MLT": "Malta", "MHL": "Marshall Islands", "MRT": "Mauritania", "MUS": "Mauritius", "MEX": "Mexico", "FSM": "Micronesia", "MDA": "Moldova", "MCO": "Monaco", "MNG": "Mongolia", "MNE": "Montenegro", "MAR": "Morocco", "MOZ": "Mozambique", "MMR": "Myanmar", "NAM": "Namibia", "NRU": "Nauru", "NPL": "Nepal", "NLD": "Nether lands", "NZL": "New Zealand", "NIC": "Nicaragua", "NER": "Niger", "NGA": "Nigeria", "MKD": "North Macedonia", "NOR": "Norway", "OMN": "Oman", "PAK": "Pakistan", "PLW": "Palau", "PAN": "Panama", "PNG": "Papua New Guinea", "PRY": "Paraguay", "PER": "Peru", "PHL": "Philippines", "POL": "Poland", "PRT": "Portugal", "QAT": "Qatar", "ROU": "Romania", "RUS": "Russian", "RWA": "Rwanda", "KNA": "Saint Kitts and Nevis", "LCA": "Saint Lucia", "VCT": "Saint Vincent and the Grenadines", "WSM": "Samoa", "SMR": "San Marino", "STP": "Sao Tome and Principe", "SAU": "Saudi Arabia", "SEN": "Senegal", "SRB": "Serbia", "SYC": "Seychelles", "SLE": "Sierra Leone", "SGP": "Singapore", "SVK": "Slovakia", "SVN": "Slovenia", "SLB": "Solomon", "SOM": "Somalia", "ZAF": "South Africa", "SSD": "South Sudan", "ESP": "Spain", "LKA": "Sri Lanka", "SDN": "Sudan", "SUR": "Suriname", "SWE": "Sweden", "CHE": "Switzer land", "SYR": "Syria", "TJK": "Tajikistan", "TZA": "Tanzania", "THA": "Thailand", "TLS": "Timor Leste", "TGO": "Togo", "TON": "Tonga", "TTO": "Trinidad and Tobago", "TUN": "Tunisia", "TUR": "Turkey", "TKM": "Turkmeni stan", "TUV": "Tuvalu", "UGA": "Uganda", "UKR": "Ukraine", "ARE": "UAE", "GBR": "United Kingdom", "USA": "USA", "URY": "Uruguay", "UZB": "Uzbekistan", "VUT": "Vanuatu", "VEN": "Venezuela", "VNM": "Viet Nam", "YEM": "Yemen", "ZMB": "Zambia", "ZWE": "Zimbabwe" };
          var table = $('#table-count').DataTable({
            "columns": [
              { className: "compact"},
              { className: "text-right text-warning compact"},
              { className: "text-right text-success compact"},
              { className: "text-right text-danger compact"}
            ],
            "stripeClasses": [],
            "info": false,      
            "order": [[ 1, "desc" ]],
            "paging": false,
            "scrollY": "180px"
          });      
          $('.dataTables_filter input').addClass('dataTableSearch');
          $.each( summary.countriesSorted_Confirmed, function(index, alpha3){
            if(alpha3 in cntry){
              country = cntry[alpha3];
            } else {
              country = alpha3;
            }
            var href_country = '<a href="/country/' + alpha3 + '">' + country + '</a>';
            confirmed = summary.countries[alpha3].confirmed;
            recovered = summary.countries[alpha3].recovered;
            deaths    = summary.countries[alpha3].deaths;
            table.row.add(
              [
                href_country, 
                confirmed.toLocaleString(),                
                recovered.toLocaleString(),
                deaths.toLocaleString()
              ]).draw();
          });
        }

        function handleGlobe(){
          var arr = JSON.parse(document.getElementById('hello-data').textContent);
          var planet = planetaryjs.planet();
          
          planet.loadPlugin(planetaryjs.plugins.earth({
            topojson: { file: 'https://raw.githubusercontent.com/BinaryMuse/planetary.js/v1.1.2/dist/world-110m.json' },
            land:     { fill:   '#4CAF50' },
            oceans:   { fill:   '#aad3df' },
            borders:  { stroke: '#1B5E20' }
          }));
          // Load our custom autorotate plugin
          planet.loadPlugin(autorotate(10));
          // Load the `pings` plugin to draw animated pings on the globe
          planet.loadPlugin(
            planetaryjs.plugins.pings({
              color: 'tomato', 
              ttl: 2000, 
              angle: 1
            })
          );
          planet.loadPlugin(planetaryjs.plugins.zoom({
            scaleExtent: [100, 500]
          }));
          planet.loadPlugin(planetaryjs.plugins.drag({
            // Dragging the globe should pause the
            // automatic rotation until we release the mouse.
            onDragStart: function() {
              this.plugins.autorotate.pause();
            },
            onDragEnd: function() {
              this.plugins.autorotate.resume();
            }
          }));
          // Make the planet fit well in its canvas
          planet.projection.scale(175).translate([175, 175]);
          var canvas = document.getElementById('globe');
          planet.draw(canvas);

          // This plugin will automatically rotate the globe around its vertical
          // axis a configured number of degrees every second.
          function autorotate(degPerSec) {
            // Planetary.js plugins are functions that take a `planet` instance as an argument...
            return function(planet) {
              var lastTick = null;
              var paused = false;
              planet.plugins.autorotate = {
                pause:  function() { paused = true;  },
                resume: function() { paused = false; }
              };
              // ...and configure hooks into certain pieces of its lifecycle.
              planet.onDraw(function() {
                if (paused || !lastTick) {
                  lastTick = new Date();
                } else {
                  var now = new Date();
                  var delta = now - lastTick;
                  // This plugin uses the built-in projection (provided by D3) to rotate the globe each time we draw it.
                  var rotation = planet.projection.rotate();
                  rotation[0] += degPerSec * delta / 1000;
                  if (rotation[0] >= 180) rotation[0] -= 360;
                  planet.projection.rotate(rotation);
                  lastTick = now;
                }
              });
            };
          };

          setInterval(function() {
            for (var i = 0; i < arr.length; i++){
              var obj = arr[i];
              lng = obj.longitude;
              lat = obj.latitude;
              latestDeathCount = obj.latest_stats_value;
              computedAngle = latestDeathCount/1000;
              if (computedAngle < 2){ computedAngle = 2}
              if (computedAngle > 5){ computedAngle = 5}
              planet.plugins.pings.add(lng, lat, { color: 'red', ttl: 1000, angle: computedAngle});
            }
          }, 1000);
        }

      });
    </script>
  </body>
</html>